language: c

sudo: false

env: PYTHONDONTWRITEBYTECODE=x

os:
    - linux

branches:
  only:
    - "master"

cache:
    apt: true
    directories:
        - $HOME/.runtimes
        - $HOME/.venv
        - $HOME/.cache/pip
        - $HOME/wheelhouse
        - $HOME/.stack
        - $HOME/.local

env:
    global:
        - BUILD_RUNTIMES=$HOME/.runtimes
        - FORMAT_ALL=true

jobs:
# Only two stages (test & deploy), for maximum throughput
  include:
    - stage: tests
    # Quick, static analysis jobs to run first
      script: python scripts/run_travis_make_task.py TASK=check-release-file
    - script: python scripts/run_travis_make_task.py TASK=check-shellcheck
    - script: python scripts/run_travis_make_task.py TASK=documentation
    - script: python scripts/run_travis_make_task.py TASK=lint
    - script: python scripts/run_travis_make_task.py TASK=check-rst
    - script: python scripts/run_travis_make_task.py TASK=check-format
    - script: python scripts/run_travis_make_task.py TASK=check-requirements

    # Important checks that we want to run on most builds, but skip if the
    # prechecks failed.
    - script: python scripts/run_travis_make_task.py TASK=check-coverage
    - script: python scripts/run_travis_make_task.py TASK=check-pypy
    - script: python scripts/run_travis_make_task.py TASK=check-py27
    - script: python scripts/run_travis_make_task.py TASK=check-py36
    - script: python scripts/run_travis_make_task.py TASK=check-quality

    # Less important tests that will probably pass whenever the above do
    # but are still worth testing.
    - script: python scripts/run_travis_make_task.py TASK=check-unicode
    - script: python scripts/run_travis_make_task.py TASK=check-ancient-pip
    - script: python scripts/run_travis_make_task.py TASK=check-py273
    - script: python scripts/run_travis_make_task.py TASK=check-py27-typing
    - script: python scripts/run_travis_make_task.py TASK=check-py34
    - script: python scripts/run_travis_make_task.py TASK=check-py35
    - script: python scripts/run_travis_make_task.py TASK=check-nose
    - script: python scripts/run_travis_make_task.py TASK=check-pytest28
    - script: python scripts/run_travis_make_task.py TASK=check-faker070
    - script: python scripts/run_travis_make_task.py TASK=check-faker071
    - script: python scripts/run_travis_make_task.py TASK=check-django18
    - script: python scripts/run_travis_make_task.py TASK=check-django110
    - script: python scripts/run_travis_make_task.py TASK=check-django111

    # Do the deploy (doesn't do anything if not on master).
    - stage: deploy
      script: python scripts/run_travis_make_task.py TASK=deploy

notifications:
  email:
    recipients:
      - david@drmaciver.com
    on_success: never
    on_failure: change

addons:
  apt:
    packages:
      - libgmp-dev
